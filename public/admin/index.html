<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Content Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
      .boot { padding: 24px; color: #111; }
      .muted { color: #666; font-size: 14px; margin-top: 8px; }
      .error { color: #b00020; margin-top: 8px; white-space: pre-wrap; }
    </style>

    <!-- Defer loading so <body> exists before scripts run -->
    <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
      // Inline CMS config (manual init) — no fetch of /admin/config.yml needed
      window.CMS_MANUAL_INIT = true;
      window.CONFIG = {
        backend: { name: "git-gateway", branch: "main" },
        media_folder: "public/uploads",
        public_folder: "/uploads",
        collections: [
          {
            name: "cms_services",
            label: "Services",
            editor: { preview: false },
            files: [
              {
                file: "public/data/services.json",
                label: "Services List",
                name: "services_file",
                format: "json",
                fields: [
                  {
                    label: "Services",
                    name: "services",
                    widget: "list",
                    fields: [
                      { label: "Name", name: "name", widget: "string" },
                      { label: "Price", name: "price", widget: "string" }
                    ]
                  }
                ]
              }
            ]
          },
          {
            name: "cms_hours",
            label: "Hours",
            editor: { preview: false },
            files: [
              {
                file: "public/data/hours.json",
                label: "Hours Table",
                name: "hours_file",
                format: "json",
                fields: [
                  {
                    label: "Hours",
                    name: "hours",
                    widget: "list",
                    fields: [
                      { label: "Day", name: "d", widget: "string" },
                      { label: "Hours", name: "h", widget: "string" }
                    ]
                  }
                ]
              }
            ]
          },
          {
            name: "cms_gallery",
            label: "Gallery",
            folder: "public/uploads/gallery",
            create: true,
            slug: "{{slug}}",
            extension: "json",
            format: "json",
            fields: [
              { label: "Title", name: "title", widget: "string" },
              { label: "Image", name: "image", widget: "image" },
              { label: "Alt Text", name: "alt", widget: "string", required: false }
            ]
          }
        ]
      };

      // Robust CMS loader: try unpkg then jsDelivr; init when loaded
      function loadCMSWithFallback() {
        function initWhenReady() {
          try {
            if (window.CMS && window.CONFIG) CMS.init({ config: window.CONFIG });
          } catch (e) {
            showError("CMS init error: " + (e?.message || e));
          }
        }
        function load(src, onload, onerror) {
          var s = document.createElement("script");
          s.src = src; s.async = true; s.onload = onload; s.onerror = onerror;
          document.head.appendChild(s);
        }
        load(
          "https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js",
          initWhenReady,
          function () {
            load(
              "https://cdn.jsdelivr.net/npm/decap-cms@^3.0.0/dist/decap-cms.js",
              initWhenReady,
              function () { showError("Could not load Decap CMS from either CDN."); }
            );
          }
        );
      }

      function showError(msg) {
        var el = document.getElementById("bootError");
        if (el) { el.style.display = "block"; el.textContent = msg; }
      }

      // Wait until <body> exists before doing anything (fixes appendChild null)
      document.addEventListener("DOMContentLoaded", function () {
        try {
          if (window.netlifyIdentity) {
            window.netlifyIdentity.init({
              APIUrl: "https://xaz-auto-detailing.netlify.app/.netlify/identity"
            });
            window.netlifyIdentity.on("login",  () => location.replace("/admin/"));
            window.netlifyIdentity.on("signup", () => location.replace("/admin/"));
            window.netlifyIdentity.on("logout", () => location.replace("/admin/"));
          }
        } catch (e) {
          showError("Identity init error: " + (e?.message || e));
        }
        loadCMSWithFallback();
      });
    </script>
  </head>
  <body>
    <div class="boot">
      <div><strong>Loading Content Manager…</strong></div>
      <div class="muted">If this stays here more than ~10 seconds, refresh the page.</div>
      <div id="bootError" class="error" style="display:none"></div>
    </div>
  </body>
</html>
